<!DOCTYPE html>
<html>
<head>
    <title>DogDrop - File Transfer</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/instascan/1.0.0/instascan.min.js"></script>
    <style>
        /* Previous styles remain, adding new ones below */
        .mode-selector {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }
        
        .mode-tab {
            padding: 10px 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .mode-tab.active {
            background-color: #4CAF50;
            color: white;
        }
        
        .qrcode-container {
            margin: 20px 0;
            text-align: center;
        }
        
        #qrScanner {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border: 2px solid #666;
            margin: 10px 0;
        }
        
        .bluetooth-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .bluetooth-connected {
            background-color: #dff0d8;
            border: 1px solid #d6e9c6;
        }
    </style>
</head>
<body>
    <h1>üêæ DogDrop - File Transfer</h1>
    
    <div class="mode-selector">
        <div class="mode-tab active" onclick="switchMode('barkcode')">BarkCode (QR)</div>
        <div class="mode-tab" onclick="switchMode('taillink')">TailLink (Bluetooth)</div>
        <div class="mode-tab" onclick="switchMode('manual')">Manual Setup</div>
    </div>

    <!-- BarkCode (QR) Section -->
    <div id="barkcodeMode" class="mode-content">
        <div class="container">
            <div class="sender">
                <h2>Sender - Show QR</h2>
                <div class="qrcode-container" id="qrcode"></div>
            </div>
            
            <div class="receiver">
                <h2>Receiver - Scan QR</h2>
                <video id="qrScanner"></video>
                <button onclick="startQRScan()">Start Scan</button>
                <button onclick="stopQRScan()">Stop Scan</button>
            </div>
        </div>
    </div>

    <!-- TailLink (Bluetooth) Section -->
    <div id="taillinkMode" class="mode-content" style="display:none;">
        <div class="container">
            <div class="sender">
                <h2>Sender - Advertise</h2>
                <div class="bluetooth-status" id="bluetoothStatus">
                    Bluetooth status: Disconnected
                </div>
                <button onclick="advertiseViaBluetooth()">Advertise via TailLink</button>
            </div>
            
            <div class="receiver">
                <h2>Receiver - Connect</h2>
                <button onclick="connectViaBluetooth()">Scan TailLink Devices</button>
                <div class="bluetooth-status" id="bluetoothReceiverStatus">
                    Status: Not connected
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Setup (Original) Section -->
    <div id="manualMode" class="mode-content" style="display:none;">
        <!-- Previous manual connection UI remains here -->
    </div>

    <script>
        // Previous WebRTC logic remains, adding new features below
        
        let currentMode = 'barkcode';
        let qrScanner = null;
        let bluetoothCharacteristic = null;

        // Mode switching
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.mode-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(mode + 'Mode').style.display = 'block';
            document.querySelector(`[onclick="switchMode('${mode}')"]`).classList.add('active');
        }

        // BarkCode QR Implementation
        function generateQR(content) {
            QRCode.toCanvas(document.getElementById('qrcode'), content, error => {
                if (error) console.error('QR generation error:', error);
            });
        }

        let scannerInstance = null;
        function startQRScan() {
            scannerInstance = new Instascan.Scanner({ video: document.getElementById('qrScanner') });
            scannerInstance.addListener('scan', content => {
                try {
                    const data = JSON.parse(content);
                    if (data.type === 'offer') handleOffer(data);
                    if (data.type === 'answer') handleAnswer(data);
                    stopQRScan();
                } catch (e) { console.error('Invalid QR data'); }
            });
            Instascan.Camera.getCameras().then(cameras => {
                if (cameras.length > 0) {
                    scannerInstance.start(cameras[0]);
                } else {
                    alert('No cameras found!');
                }
            });
        }

        function stopQRScan() {
            if (scannerInstance) {
                scannerInstance.stop();
                scannerInstance = null;
            }
        }

        // TailLink Bluetooth Implementation
        const BLUETOOTH_SERVICE_UUID = 'a8b3f524-3a85-4e7f-91ab-8e5a3f6b3a7d';
        const SDP_CHARACTERISTIC_UUID = 'b42e3c68-ade7-4d85-90c9-0a5f49a1f6a1';

        async function advertiseViaBluetooth() {
            try {
                const service = {
                    uuid: BLUETOOTH_SERVICE_UUID,
                    characteristics: [
                        {
                            uuid: SDP_CHARACTERISTIC_UUID,
                            properties: ['read', 'write', 'notify'],
                            descriptors: [{ uuid: '2901', value: 'DogDrop SDP Exchange' }]
                        }
                    ]
                };

                const server = await navigator.bluetooth.requestAdvertising({
                    services: [BLUETOOTH_SERVICE_UUID],
                    name: 'DogDrop-Sender'
                });

                document.getElementById('bluetoothStatus').innerHTML = 
                    'Advertising via TailLink... Waiting for connection';
                
                server.onconnect = async () => {
                    document.getElementById('bluetoothStatus').innerHTML = 
                        'Connected via TailLink!';
                    await setupBluetoothConnection(server);
                };
            } catch (error) {
                console.error('Bluetooth error:', error);
            }
        }

        async function connectViaBluetooth() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [BLUETOOTH_SERVICE_UUID] }],
                    optionalServices: [BLUETOOTH_SERVICE_UUID]
                });

                const server = await device.gatt.connect();
                document.getElementById('bluetoothReceiverStatus').innerHTML = 
                    'Connected! Setting up...';

                const service = await server.getPrimaryService(BLUETOOTH_SERVICE_UUID);
                const characteristic = await service.getCharacteristic(SDP_CHARACTERISTIC_UUID);
                
                characteristic.addEventListener('characteristicvaluechanged', event => {
                    const value = new TextDecoder().decode(event.target.value);
                    handleBluetoothMessage(value);
                });
                await characteristic.startNotifications();
                
                bluetoothCharacteristic = characteristic;
                document.getElementById('bluetoothReceiverStatus').innerHTML = 
                    'TailLink connection established!';
            } catch (error) {
                console.error('Bluetooth connection error:', error);
            }
        }

        async function handleBluetoothMessage(message) {
            try {
                const data = JSON.parse(message);
                if (data.type === 'offer') {
                    const answer = await createAnswer(data);
                    await bluetoothCharacteristic.writeValue(
                        new TextEncoder().encode(JSON.stringify(answer))
                    );
                }
                if (data.type === 'answer') {
                    await handleAnswer(data);
                }
            } catch (e) { console.error('Bluetooth message error:', e); }
        }

        // Modified WebRTC functions to support new modes
        async function startSharing() {
            // Modified to generate QR code for BarkCode
            if (currentMode === 'barkcode') {
                generateQR(JSON.stringify(peerConnection.localDescription));
            }
            // Original WebRTC logic
        }

        // Add Bluetooth handlers to existing WebRTC logic
        function setupDataChannel(channel) {
            channel.onopen = () => {
                if (currentMode === 'taillink') {
                    document.getElementById('bluetoothStatus').innerHTML += '<br>Data channel ready!';
                }
                sendNextFile();
            };
        }
    </script>
</body>
</html>
